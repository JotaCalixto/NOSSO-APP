<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Nosso App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#7C3AED" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Nosso App" />
  <link rel="apple-touch-icon" href="nosso-app-icon.png" />

  <!-- Manifest inline simples para PWA em GitHub Pages -->
  <link
    rel="manifest"
    href='data:application/json,{
      "name":"Nosso App",
      "short_name":"Nosso App",
      "start_url":".",
      "display":"standalone",
      "background_color":"#050816",
      "theme_color":"#7C3AED"
    }'
  />

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBahDvZPq78LQLlKv-1tqAskZJWP9UXfb0",
      authDomain: "nosso-app-b9917.firebaseapp.com",
      projectId: "nosso-app-b9917",
      storageBucket: "nosso-app-b9917.firebasestorage.app",
      messagingSenderId: "994549530268",
      appId: "1:994549530268:web:96f8dc4cb2d9586b9f7759",
      measurementId: "G-PSZ2969HZ9"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const messaging = firebase.messaging();
  </script>

  <style>
    /* === teu CSS original aqui (mantive igual ao arquivo) === */
    :root {
      --bg: #050816;
      --bg-elevated: #0f172a;
      --bg-soft: #111827;
      --primary: #7c3aed;
      --primary-soft: rgba(124, 58, 237, 0.2);
      --primary-soft-strong: rgba(124, 58, 237, 0.35);
      --accent: #f97316;
      --accent-soft: rgba(249, 115, 22, 0.18);
      --success: #22c55e;
      --danger: #ef4444;
      --text: #f9fafb;
      --text-muted: #9ca3af;
      --border: #1f2937;
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-sm: 999px;
      --shadow-soft: 0 20px 40px rgba(15, 23, 42, 0.75);
      --shadow-chip: 0 8px 16px rgba(15, 23, 42, 0.9);
      --transition-fast: 180ms ease-out;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      height: 100%;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', system-ui,
        sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 52%, #000 100%);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }

    .app-shell {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      padding: 16px 14px 22px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .app-card {
      background: radial-gradient(circle at top left, #1f2937 0, #020617 55%);
      border-radius: 26px;
      padding: 18px 18px 14px;
      border: 1px solid rgba(148, 163, 184, 0.15);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(24px);
    }

    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 14px;
    }

    .app-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .app-avatar {
      width: 32px;
      height: 32px;
      border-radius: 24px;
      background: radial-gradient(circle at 30% 20%, #f97316, #7c3aed);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-chip);
      font-size: 18px;
    }

    .app-title-text h1 {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .app-title-text span {
      font-size: 12px;
      color: var(--text-muted);
    }

    .chip {
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--primary-soft);
      border: 1px solid rgba(129, 140, 248, 0.25);
      color: #e5e7eb;
      box-shadow: var(--shadow-chip);
    }

    .chip-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 5px rgba(34, 197, 94, 0.25);
    }

    .summary-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }

    .summary-card {
      background: linear-gradient(145deg, #0b1120, #111827);
      border-radius: 16px;
      padding: 10px 10px 9px;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    .summary-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .summary-value {
      font-size: 17px;
      font-weight: 700;
    }

    .summary-pill {
      font-size: 11px;
      color: var(--accent);
      margin-top: 2px;
    }

    .summary-value.tasks {
      color: #22c55e;
    }

    .summary-value.shopping {
      color: #facc15;
    }

    .summary-value.events {
      color: #38bdf8;
    }

    .tab-nav {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 6px;
      margin-top: 10px;
      padding: 4px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.88);
      border: 1px solid rgba(148, 163, 184, 0.18);
    }

    .tab-button {
      border-radius: 999px;
      border: none;
      padding: 8px 6px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      background: transparent;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .tab-button span.icon {
      font-size: 15px;
    }

    .tab-button.active {
      background: radial-gradient(circle at top, #7c3aed, #4c1d95);
      color: #f9fafb;
      box-shadow: 0 0 0 1px rgba(94, 234, 212, 0.18),
        var(--shadow-chip);
    }

    .tab-button:not(.active):hover {
      background: rgba(31, 41, 55, 0.9);
    }

    .content-card {
      margin-top: 10px;
      border-radius: 20px;
      padding: 14px 14px 10px;
      background: linear-gradient(145deg, #020617, #020617);
      border: 1px solid rgba(31, 41, 55, 0.9);
      box-shadow: var(--shadow-soft);
    }

    .section-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .section-title-row h2 {
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.01em;
    }

    .section-title-row span {
      font-size: 11px;
      color: var(--text-muted);
    }

    .list-scroll {
      max-height: calc(100vh - 360px);
      overflow-y: auto;
      padding-right: 4px;
      margin-top: 4px;
    }

    .list-scroll::-webkit-scrollbar {
      width: 4px;
    }

    .list-scroll::-webkit-scrollbar-track {
      background: transparent;
    }

    .list-scroll::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.5);
      border-radius: 999px;
    }

    .item-card {
      background: radial-gradient(circle at top left, #020617, #020617);
      border-radius: 16px;
      padding: 9px 10px 9px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }

    .checkbox-wrap {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .checkbox-input {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid rgba(148, 163, 184, 0.9);
      background: transparent;
      outline: none;
      cursor: pointer;
      appearance: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.95);
    }

    .checkbox-input:checked {
      background: radial-gradient(circle at 30% 20%, #22c55e, #4ade80);
      border-color: #22c55e;
    }

    .checkbox-input:checked::after {
      content: '‚úì';
      font-size: 12px;
      color: #f9fafb;
    }

    .item-main {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .item-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .item-title {
      font-size: 14px;
      font-weight: 600;
    }

    .item-meta {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .item-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .tag {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    .tag-pill {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      white-space: nowrap;
    }

    .tag-pill.todo {
      border-color: rgba(248, 250, 252, 0.35);
      background: rgba(59, 130, 246, 0.2);
    }

    .tag-pill.done {
      border-color: rgba(45, 212, 191, 0.6);
      background: rgba(16, 185, 129, 0.2);
      color: #a7f3d0;
    }

    .item-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-end;
    }

    .icon-btn {
      border-radius: 999px;
      border: none;
      width: 26px;
      height: 26px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
      background: rgba(31, 41, 55, 0.95);
      color: #f9fafb;
      border: 1px solid rgba(148, 163, 184, 0.7);
    }

    .icon-btn.danger {
      background: rgba(127, 29, 29, 0.95);
      border-color: rgba(248, 113, 113, 0.65);
    }

    .icon-btn.secondary {
      background: rgba(15, 23, 42, 0.9);
    }

    .icon-btn:active {
      transform: scale(0.96);
    }

    .strikethrough {
      text-decoration: line-through;
      color: #6b7280;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }

    .form-grid-full {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 8px;
      margin-bottom: 8px;
    }

    .field-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 3px;
    }

    .field-input,
    .field-select,
    .field-textarea {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.9);
      color: #f9fafb;
      font-size: 13px;
      padding: 7px 10px;
      outline: none;
    }

    .field-textarea {
      border-radius: 12px;
      resize: vertical;
      min-height: 60px;
      font-size: 12px;
    }

    .field-input::placeholder,
    .field-textarea::placeholder {
      color: #6b7280;
    }

    .btn-primary {
      margin-top: 4px;
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 9px 0;
      font-size: 13px;
      font-weight: 600;
      background: radial-gradient(circle at top, #7c3aed, #4c1d95);
      color: #f9fafb;
      box-shadow: 0 12px 24px rgba(88, 28, 135, 0.7);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      transition: transform var(--transition-fast),
        box-shadow var(--transition-fast);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 28px rgba(88, 28, 135, 0.9);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 8px 18px rgba(88, 28, 135, 0.7);
    }

    .btn-secondary {
      border-radius: 999px;
      border: none;
      padding: 7px 10px;
      font-size: 12px;
      font-weight: 500;
      background: rgba(17, 24, 39, 0.95);
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.6);
      cursor: pointer;
    }

    .btn-secondary.danger {
      background: rgba(127, 29, 29, 0.9);
      border-color: rgba(248, 113, 113, 0.75);
      color: #fee2e2;
    }

    .btn-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-top: 6px;
    }

    .footer-note {
      margin-top: 6px;
      font-size: 10px;
      color: var(--text-muted);
      text-align: center;
    }

    .footer-note span {
      color: #f5e7eb;
    }

    @media (max-width: 400px) {
      .app-card {
        border-radius: 20px;
        padding-inline: 14px;
      }

      .content-card {
        border-radius: 18px;
      }

      .summary-row {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }

      .app-title-text h1 {
        font-size: 18px;
      }
    }

    .toast {
      position: fixed;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%) translateY(120%);
      background: rgba(15, 23, 42, 0.98);
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 8px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #e5e7eb;
      box-shadow: 0 16px 32px rgba(15, 23, 42, 0.9);
      opacity: 0;
      pointer-events: none;
      transition: transform 200ms ease-out, opacity 200ms ease-out;
      z-index: 50;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
      pointer-events: auto;
    }

    .toast-badge {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #a855f7, #4c1d95);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.6);
    }

    .toast-close {
      border-radius: 999px;
      border: none;
      width: 20px;
      height: 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      background: transparent;
      color: #9ca3af;
      cursor: pointer;
    }

    .summary-prompt {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="app-card">
      <header class="app-header">
        <div class="app-title">
          <div class="app-avatar">üíú</div>
          <div class="app-title-text">
            <h1>Nosso App</h1>
            <span>Planner compartilhado ‚Ä¢ voc√™s dois</span>
          </div>
        </div>
        <div class="chip">
          <span class="chip-dot"></span>
          <span>Online hoje juntos</span>
        </div>
      </header>

      <section class="summary-row">
        <div class="summary-card">
          <div class="summary-label">Tarefas em aberto</div>
          <div class="summary-value tasks" id="summaryTasks">0</div>
          <div class="summary-pill">Foco do dia</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Itens de compra</div>
          <div class="summary-value shopping" id="summaryShopping">0</div>
          <div class="summary-pill">Lista do mercado</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Pr√≥ximos eventos</div>
          <div class="summary-value events" id="summaryEvents">0</div>
          <div class="summary-pill">Momentos a dois</div>
        </div>
      </section>

      <nav class="tab-nav" aria-label="Se√ß√µes">
        <button class="tab-button active" data-tab="tasks">
          <span class="icon">‚úÖ</span>
          <span>Tarefas</span>
        </button>
        <button class="tab-button" data-tab="shopping">
          <span class="icon">üõí</span>
          <span>Compras</span>
        </button>
        <button class="tab-button" data-tab="events">
          <span class="icon">üéü</span>
          <span>Eventos</span>
        </button>
      </nav>

      <!-- Tarefas -->
      <section class="content-card" data-content="tasks">
        <div class="section-title-row">
          <div>
            <h2>Tarefas de hoje</h2>
            <span>Coisas que voc√™s n√£o querem esquecer</span>
          </div>
          <button class="btn-secondary" id="clearTasksBtn">Limpar conclu√≠das</button>
        </div>

        <form id="taskForm">
          <div class="form-grid">
            <div>
              <label class="field-label" for="taskTitle">Tarefa</label>
              <input id="taskTitle" class="field-input" type="text" placeholder="Ex.: Ligar pro plano de sa√∫de..." required />
            </div>
            <div>
              <label class="field-label" for="taskOwner">Respons√°vel</label>
              <select id="taskOwner" class="field-select">
                <option value="">N√≥s dois</option>
                <option value="Ele">Ele</option>
                <option value="Ela">Ela</option>
              </select>
            </div>
          </div>

          <div class="form-grid">
            <div>
              <label class="field-label" for="taskDueDate">Prazo</label>
              <input id="taskDueDate" class="field-input" type="date" />
            </div>
            <div>
              <label class="field-label" for="taskPriority">Prioridade</label>
              <select id="taskPriority" class="field-select">
                <option value="Alta">Alta</option>
                <option value="M√©dia" selected>M√©dia</option>
                <option value="Baixa">Baixa</option>
              </select>
            </div>
          </div>

          <div class="form-grid-full">
            <div>
              <label class="field-label" for="taskNotes">Detalhes</label>
              <textarea
                id="taskNotes"
                class="field-textarea"
                placeholder="Algum detalhe importante, n√∫mero de protocolo, endere√ßo..."
              ></textarea>
            </div>
          </div>

          <button class="btn-primary" type="submit">
            <span class="icon">‚ûï</span>
            <span>Adicionar tarefa</span>
          </button>
        </form>

        <div class="list-scroll" id="taskList"></div>
      </section>

      <!-- Compras -->
      <section class="content-card" data-content="shopping" style="display:none;">
        <div class="section-title-row">
          <div>
            <h2>Lista de compras</h2>
            <span>Tudo o que n√£o pode faltar quando voc√™s sa√≠rem</span>
          </div>
          <button class="btn-secondary" id="exportShoppingBtn">Exportar checklist</button>
        </div>

        <form id="shoppingForm">
          <div class="form-grid">
            <div>
              <label class="field-label" for="shoppingTitle">Item</label>
              <input id="shoppingTitle" class="field-input" type="text" placeholder="Ex.: Caf√©, carne, cerveja..." required />
            </div>
            <div>
              <label class="field-label" for="shoppingCategory">Categoria</label>
              <input id="shoppingCategory" class="field-input" type="text" placeholder="Ex.: Mercado, farm√°cia..." />
            </div>
          </div>

          <div class="form-grid">
            <div>
              <label class="field-label" for="shoppingQty">Quantidade</label>
              <input id="shoppingQty" class="field-input" type="text" placeholder="Ex.: 2kg, 3 unidades..." />
            </div>
            <div>
              <label class="field-label" for="shoppingOwner">Quem vai pegar</label>
              <select id="shoppingOwner" class="field-select">
                <option value="">N√≥s dois</option>
                <option value="Ele">Ele</option>
                <option value="Ela">Ela</option>
              </select>
            </div>
          </div>

          <button class="btn-primary" type="submit">
            <span class="icon">üõç</span>
            <span>Adicionar √† lista</span>
          </button>
        </form>

        <div class="list-scroll" id="shoppingList"></div>
      </section>

      <!-- Eventos -->
      <section class="content-card" data-content="events" style="display:none;">
        <div class="section-title-row">
          <div>
            <h2>Eventos e rol√™s</h2>
            <span>Shows, viagens, jantares e tudo que voc√™s querem viver juntos</span>
          </div>
          <button class="btn-secondary danger" id="clearPastEventsBtn">Limpar eventos passados</button>
        </div>

        <form id="eventForm">
          <div class="form-grid-full">
            <div>
              <label class="field-label" for="eventTitle">Evento</label>
              <input
                id="eventTitle"
                class="field-input"
                type="text"
                placeholder="Ex.: Cinema, viagem, jantar especial..."
                required
              />
            </div>
          </div>

          <div class="form-grid">
            <div>
              <label class="field-label" for="eventStatus">Status</label>
              <select id="eventStatus" class="field-select">
                <option value="Estamos pensando">Estamos pensando</option>
                <option value="Prov√°vel">Prov√°vel</option>
                <option value="Confirmado">Confirmado</option>
              </select>
            </div>
          </div>

          <div class="form-grid">
            <div>
              <label class="field-label" for="eventDate">Data</label>
              <input id="eventDate" class="field-input" type="date" />
            </div>
            <div>
              <label class="field-label" for="eventTime">Hora</label>
              <input id="eventTime" class="field-input" type="time" />
            </div>
          </div>

          <div class="form-grid-full">
            <div>
              <label class="field-label" for="eventPlace">Local</label>
              <input
                id="eventPlace"
                class="field-input"
                type="text"
                placeholder="Ex.: Shopping, restaurante, cidade..."
              />
            </div>
          </div>

          <div class="form-grid-full">
            <div>
              <label class="field-label" for="eventNotes">Detalhes</label>
              <textarea
                id="eventNotes"
                class="field-textarea"
                placeholder="Ingressos, reservas, roupas, transporte..."
              ></textarea>
            </div>
          </div>

          <button class="btn-primary" type="submit">
            <span class="icon">üìÖ</span>
            <span>Registrar evento</span>
          </button>
        </form>

        <div class="list-scroll" id="eventList"></div>
      </section>

      <p class="footer-note">
        Dados agora salvos na nuvem com <span>Firestore</span>.<br />
        Voc√™s podem abrir o app em aparelhos diferentes e ver tudo sincronizado.
      </p>
    </div>
  </div>

  <div class="toast" id="toast">
    <div class="toast-text">
      <div class="toast-badge">‚ú®</div>
      <span id="toastMessage">Item adicionado</span>
    </div>
    <button class="toast-close" id="toastCloseBtn" aria-label="Fechar">√ó</button>
  </div>

  <script>
      // registrar o service worker do Firebase Messaging
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker
      .register('/NOSSO-APP/firebase-messaging-sw.js')
      .then((registration) => {
        console.log('SW registrado', registration.scope);
      })
      .catch((err) => {
        console.error('Erro ao registrar SW', err);
      });
  }

    const state = {
      tasks: [],
      shopping: [],
      events: []
    };

    function uuid() {
      return (
        Date.now().toString(36) +
        '-' +
        Math.random().toString(36).substring(2, 8)
      );
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      const msgEl = document.getElementById('toastMessage');
      msgEl.textContent = message;
      toast.classList.add('show');
      clearTimeout(showToast._timeout);
      showToast._timeout = setTimeout(() => {
        toast.classList.remove('show');
      }, 3500);
    }

    function updateSummaries() {
      const openTasks = state.tasks.filter((t) => !t.done).length;
      const pendingShopping = state.shopping.filter((s) => !s.checked).length;
      const upcomingEvents = state.events.filter((e) => !isPastEvent(e)).length;

      document.getElementById('summaryTasks').textContent = openTasks;
      document.getElementById('summaryShopping').textContent = pendingShopping;
      document.getElementById('summaryEvents').textContent = upcomingEvents;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const [year, month, day] = dateStr.split('-');
      if (!year || !month || !day) return dateStr;
      return `${day}/${month}`;
    }

    function isPastEvent(ev) {
      if (!ev.date) return false;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const evDate = new Date(ev.date + 'T' + (ev.time || '00:00'));
      return evDate < today;
    }

    // === REALTIME LISTENERS FIRESTORE ===
    function initRealtimeListeners() {
      db.collection('tasks').orderBy('createdAt', 'desc').onSnapshot((snap) => {
        state.tasks = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderTasks();
        updateSummaries();
      });

      db.collection('shopping').orderBy('createdAt', 'desc').onSnapshot((snap) => {
        state.shopping = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderShopping();
        updateSummaries();
      });

      db.collection('events').orderBy('createdAt', 'desc').onSnapshot((snap) => {
        state.events = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderEvents();
        updateSummaries();
      });
    }

    function renderTasks() {
      const container = document.getElementById('taskList');
      if (!state.tasks.length) {
        container.innerHTML =
          '<p style="font-size:12px;color:#6b7280;text-align:center;margin-top:4px;">Nada aqui ainda. Comece adicionando a primeira tarefa do dia ‚ú®</p>';
        return;
      }

      const sorted = [...state.tasks].sort((a, b) => {
        if (a.done !== b.done) return a.done ? 1 : -1;
        if (a.dueDate && b.dueDate) return a.dueDate.localeCompare(b.dueDate);
        if (a.dueDate) return -1;
        if (b.dueDate) return 1;
        return b.createdAt - a.createdAt;
      });

      container.innerHTML = '';
      for (const task of sorted) {
        const wrapper = document.createElement('div');
        wrapper.className = 'item-card';

        const checkboxCol = document.createElement('div');
        checkboxCol.className = 'checkbox-wrap';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'checkbox-input';
        checkbox.checked = !!task.done;
        checkbox.addEventListener('change', async () => {
          task.done = checkbox.checked;
          await db.collection('tasks').doc(task.id).update({
            done: task.done
          });
        });
        checkboxCol.appendChild(checkbox);

        const main = document.createElement('div');
        main.className = 'item-main';

        const titleRow = document.createElement('div');
        titleRow.className = 'item-title-row';

        const title = document.createElement('div');
        title.className = 'item-title';
        if (task.done) title.classList.add('strikethrough');
        title.textContent = task.title || 'Tarefa';

        const pill = document.createElement('span');
        pill.className = 'tag-pill ' + (task.done ? 'done' : 'todo');
        pill.textContent = task.done ? 'Conclu√≠da' : 'Em aberto';

        titleRow.appendChild(title);
        titleRow.appendChild(pill);

        const meta = document.createElement('div');
        meta.className = 'item-meta';
        const owner = document.createElement('span');
        owner.textContent = task.owner || 'N√≥s dois';
        const priority = document.createElement('span');
        priority.textContent = 'Prioridade: ' + (task.priority || 'M√©dia');
        const due = document.createElement('span');
        due.textContent = 'Prazo: ' + (formatDate(task.dueDate) || '-');

        meta.appendChild(owner);
        meta.appendChild(priority);
        meta.appendChild(due);

        const tags = document.createElement('div');
        tags.className = 'item-tags';
        if (task.notes) {
          const noteTag = document.createElement('span');
          noteTag.className = 'tag';
          noteTag.textContent =
            task.notes.length > 40
              ? task.notes.slice(0, 37) + '...'
              : task.notes;
          tags.appendChild(noteTag);
        }

        main.appendChild(titleRow);
        main.appendChild(meta);
        if (task.notes) main.appendChild(tags);

        const actions = document.createElement('div');
        actions.className = 'item-actions';

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'icon-btn danger';
        deleteBtn.innerHTML = 'üóë';
        deleteBtn.title = 'Remover tarefa';
        deleteBtn.addEventListener('click', async () => {
          if (
            confirm(
              'Remover esta tarefa da lista? Esta a√ß√£o n√£o pode ser desfeita.'
            )
          ) {
            await db.collection('tasks').doc(task.id).delete();
          }
        });

        actions.appendChild(deleteBtn);

        wrapper.appendChild(checkboxCol);
        wrapper.appendChild(main);
        wrapper.appendChild(actions);

        container.appendChild(wrapper);
      }
    }

    function renderShopping() {
      const container = document.getElementById('shoppingList');
      if (!state.shopping.length) {
        container.innerHTML =
          '<p style="font-size:12px;color:#6b7280;text-align:center;margin-top:4px;">Sua lista est√° vazia. Comece adicionando o primeiro item üõí</p>';
        return;
      }

      const sorted = [...state.shopping].sort((a, b) => {
        if (a.checked !== b.checked) return a.checked ? 1 : -1;
        return b.createdAt - a.createdAt;
      });

      container.innerHTML = '';
      for (const item of sorted) {
        const wrapper = document.createElement('div');
        wrapper.className = 'item-card';

        const checkboxCol = document.createElement('div');
        checkboxCol.className = 'checkbox-wrap';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'checkbox-input';
        checkbox.checked = !!item.checked;
        checkbox.addEventListener('change', async () => {
          item.checked = checkbox.checked;
          await db.collection('shopping').doc(item.id).update({
            checked: item.checked
          });
        });
        checkboxCol.appendChild(checkbox);

        const main = document.createElement('div');
        main.className = 'item-main';

        const titleRow = document.createElement('div');
        titleRow.className = 'item-title-row';

        const title = document.createElement('div');
        title.className = 'item-title';
        if (item.checked) title.classList.add('strikethrough');
        title.textContent = item.title || 'Item';

        const pill = document.createElement('span');
        pill.className = 'tag-pill ' + (item.checked ? 'done' : 'todo');
        pill.textContent = item.checked ? 'Pegamos' : 'Falta pegar';

        titleRow.appendChild(title);
        titleRow.appendChild(pill);

        const meta = document.createElement('div');
        meta.className = 'item-meta';

        const cat = document.createElement('span');
        cat.textContent = item.category || 'Mercado';
        const qty = document.createElement('span');
        qty.textContent = 'Qtd: ' + (item.qty || '-');
        const owner = document.createElement('span');
        owner.textContent = item.owner || 'N√≥s dois';

        meta.appendChild(cat);
        meta.appendChild(qty);
        meta.appendChild(owner);

        main.appendChild(titleRow);
        main.appendChild(meta);

        const actions = document.createElement('div');
        actions.className = 'item-actions';

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'icon-btn danger';
        deleteBtn.innerHTML = 'üóë';
        deleteBtn.title = 'Remover item';
        deleteBtn.addEventListener('click', async () => {
          if (confirm('Remover este item da lista de compras?')) {
            await db.collection('shopping').doc(item.id).delete();
          }
        });

        actions.appendChild(deleteBtn);

        wrapper.appendChild(checkboxCol);
        wrapper.appendChild(main);
        wrapper.appendChild(actions);

        container.appendChild(wrapper);
      }
    }

    function renderEvents() {
      const container = document.getElementById('eventList');
      if (!state.events.length) {
        container.innerHTML =
          '<p style="font-size:12px;color:#6b7280;text-align:center;margin-top:4px;">Nenhum evento ainda. planejem algo juntos hoje üíú</p>';
        return;
      }

      const sorted = [...state.events].sort((a, b) => {
        if (!a.date && !b.date) return b.createdAt - a.createdAt;
        if (!a.date) return 1;
        if (!b.date) return -1;
        return a.date.localeCompare(b.date);
      });

      container.innerHTML = '';
      for (const ev of sorted) {
        const wrapper = document.createElement('div');
        wrapper.className = 'item-card';

        const badgeCol = document.createElement('div');
        badgeCol.className = 'checkbox-wrap';
        const badge = document.createElement('div');
        badge.style.width = '18px';
        badge.style.height = '18px';
        badge.style.borderRadius = '999px';
        badge.style.border = '2px solid rgba(55,65,81,0.9)';
        badge.style.boxShadow = '0 0 0 1px rgba(15,23,42,0.9)';

        let bg = '#38bdf8';
        if (ev.status === 'Confirmado') bg = '#22c55e';
        else if (ev.status === 'Estamos pensando') bg = '#f97316';
        if (isPastEvent(ev)) bg = '#6b7280';

        badge.style.background = bg;
        badgeCol.appendChild(badge);

        const main = document.createElement('div');
        main.className = 'item-main';

        const titleRow = document.createElement('div');
        titleRow.className = 'item-title-row';

        const title = document.createElement('div');
        title.className = 'item-title';
        title.textContent = ev.title || 'Evento';

        const pill = document.createElement('span');
        pill.className = 'tag-pill';
        pill.style.background =
          ev.status === 'Confirmado'
            ? 'rgba(34,197,94,0.25)'
            : ev.status === 'Prov√°vel'
            ? 'rgba(56,189,248,0.25)'
            : 'rgba(249,115,22,0.25)';
        pill.textContent = isPastEvent(ev)
          ? 'J√° passou'
          : ev.status || 'Estamos pensando';

        titleRow.appendChild(title);
        titleRow.appendChild(pill);

        const meta = document.createElement('div');
        meta.className = 'item-meta';

        const date = document.createElement('span');
        date.textContent = 'Data: ' + (formatDate(ev.date) || '-');

        const time = document.createElement('span');
        time.textContent = 'Hora: ' + (ev.time || '-');

        const place = document.createElement('span');
        place.textContent = ev.place ? 'Local: ' + ev.place : 'Local a definir';

        meta.appendChild(date);
        meta.appendChild(time);
        meta.appendChild(place);

        const tags = document.createElement('div');
        tags.className = 'item-tags';
        if (ev.notes) {
          const noteTag = document.createElement('span');
          noteTag.className = 'tag';
          noteTag.textContent =
            ev.notes.length > 50 ? ev.notes.slice(0, 47) + '...' : ev.notes;
          tags.appendChild(noteTag);
        }

        main.appendChild(titleRow);
        main.appendChild(meta);
        if (ev.notes) main.appendChild(tags);

        const actions = document.createElement('div');
        actions.className = 'item-actions';

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'icon-btn danger';
        deleteBtn.innerHTML = 'üóë';
        deleteBtn.title = 'Remover evento';
        deleteBtn.addEventListener('click', async () => {
          if (confirm('Remover este evento da lista?')) {
            await db.collection('events').doc(ev.id).delete();
          }
        });

        actions.appendChild(deleteBtn);

        wrapper.appendChild(badgeCol);
        wrapper.appendChild(main);
        wrapper.appendChild(actions);

        container.appendChild(wrapper);
      }
    }

    async function handleTaskSubmit(e) {
      e.preventDefault();
      const title = document.getElementById('taskTitle').value.trim();
      if (!title) return;

      const task = {
        title,
        owner: document.getElementById('taskOwner').value || 'N√≥s dois',
        dueDate: document.getElementById('taskDueDate').value || '',
        priority: document.getElementById('taskPriority').value || 'M√©dia',
        notes: document.getElementById('taskNotes').value.trim(),
        done: false,
        createdAt: Date.now()
      };

      await db.collection('tasks').add(task);
      showToast('Tarefa adicionada √† lista üí™');
      e.target.reset();
    }

    async function handleShoppingSubmit(e) {
      e.preventDefault();
      const title = document.getElementById('shoppingTitle').value.trim();
      if (!title) return;

      const item = {
        title,
        category: document.getElementById('shoppingCategory').value || 'Mercado',
        qty: document.getElementById('shoppingQty').value.trim(),
        owner: document.getElementById('shoppingOwner').value || 'N√≥s dois',
        checked: false,
        createdAt: Date.now()
      };

      await db.collection('shopping').add(item);
      showToast('Item adicionado √† lista de compras üõí');
      e.target.reset();
    }

    async function handleEventSubmit(e) {
      e.preventDefault();
      const title = document.getElementById('eventTitle').value.trim();
      if (!title) return;

      const ev = {
        title,
        status: document.getElementById('eventStatus').value || 'Estamos pensando',
        date: document.getElementById('eventDate').value || '',
        time: document.getElementById('eventTime').value || '',
        place: document.getElementById('eventPlace').value.trim(),
        notes: document.getElementById('eventNotes').value.trim(),
        createdAt: Date.now()
      };

      await db.collection('events').add(ev);
      showToast('Novo evento registrado üìÖ');
      e.target.reset();
    }

    function handleExportShopping() {
      if (!state.shopping.length) {
        alert('A lista ainda est√° vazia.');
        return;
      }

      const lines = [];
      lines.push('CHECKLIST DE COMPRAS - NOSSO APP');
      lines.push(
        'Itens marcados como "Pegamos" n√£o aparecem na lista abaixo.'
      );
      lines.push('');
      const pending = state.shopping.filter((i) => !i.checked);
      if (!pending.length) {
        lines.push('Nenhum item pendente. Tudo pronto! üéâ');
      } else {
        pending.forEach((item, idx) => {
          const base =
            `${idx + 1}. [ ] ${item.title}` +
            (item.qty ? ` (${item.qty})` : '');
          const cat = item.category ? ` ‚Ä¢ ${item.category}` : '';
          lines.push(base + cat);
        });
      }

      const content = lines.join('\n');
      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download =
        'checklist-compras-nosso-app-' +
        new Date().toISOString().slice(0, 10) +
        '.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast('Checklist de compras exportado ‚úÖ');
    }

    async function clearCompletedTasks() {
      const doneTasks = state.tasks.filter((t) => t.done);
      if (!doneTasks.length) {
        alert('Nenhuma tarefa conclu√≠da para limpar.');
        return;
      }
      if (
        !confirm(
          'Remover todas as tarefas marcadas como conclu√≠das? Esta a√ß√£o n√£o pode ser desfeita.'
        )
      ) {
        return;
      }

      const batch = db.batch();
      doneTasks.forEach((t) => {
        const ref = db.collection('tasks').doc(t.id);
        batch.delete(ref);
      });
      await batch.commit();
    }

    async function clearPastEvents() {
      const past = state.events.filter((e) => isPastEvent(e));
      if (!past.length) {
        alert('Nenhum evento passado para limpar.');
        return;
      }
      if (
        !confirm(
          'Remover todos os eventos que j√° aconteceram? Esta a√ß√£o n√£o pode ser desfeita.'
        )
      ) {
        return;
      }

      const batch = db.batch();
      past.forEach((e) => {
        const ref = db.collection('events').doc(e.id);
        batch.delete(ref);
      });
      await batch.commit();
    }

    function setupTabs() {
      const buttons = document.querySelectorAll('.tab-button');
      const sections = document.querySelectorAll('[data-content]');
      buttons.forEach((btn) => {
        btn.addEventListener('click', () => {
          buttons.forEach((b) => b.classList.remove('active'));
          btn.classList.add('active');
          const target = btn.getAttribute('data-tab');
          sections.forEach((sec) => {
            sec.style.display =
              sec.getAttribute('data-content') === target ? 'block' : 'none';
          });
        });
      });
    }

    function setupToast() {
      const toast = document.getElementById('toast');
      const close = document.getElementById('toastCloseBtn');
      close.addEventListener('click', () => toast.classList.remove('show'));
    }
    async function initNotifications() {
  if (!('Notification' in window)) {
    console.log('Navegador n√£o suporta Notification');
    return;
  }

  const permission = await Notification.requestPermission();
  if (permission !== 'granted') {
    console.log('Permiss√£o de notifica√ß√£o negada');
    return;
  }

  try {
    const token = await messaging.getToken({
      vapidKey: 'BATYttoudldnMFR_1ljGFls_25xhUr1UKP07W3W5coARn4l9_kF3xuWpEN5V17KUtLgxWCpnPELEbHaMZg5YpTo'
    });

    console.log('FCM token:', token);
  } catch (err) {
    console.error('Erro ao obter token FCM', err);
  }
}


    document.addEventListener('DOMContentLoaded', () => {
      setupTabs();
      setupToast();

      document
        .getElementById('taskForm')
        .addEventListener('submit', handleTaskSubmit);
      document
        .getElementById('shoppingForm')
        .addEventListener('submit', handleShoppingSubmit);
      document
        .getElementById('eventForm')
        .addEventListener('submit', handleEventSubmit);

      document
        .getElementById('exportShoppingBtn')
        .addEventListener('click', handleExportShopping);
      document
        .getElementById('clearTasksBtn')
        .addEventListener('click', clearCompletedTasks);
      document
        .getElementById('clearPastEventsBtn')
        .addEventListener('click', clearPastEvents);

      // Ativar realtime
      initRealtimeListeners();

      // pedir permiss√£o de push
      initNotifications();
    });
  </script>
</body>
</html>
